{% extends "base.html" %}

{% block title %}Instruções dos Modelos - DIRIA{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-robot text-3xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <h1 class="text-2xl font-bold text-gray-900">Instruções dos Modelos</h1>
                    <p class="text-sm text-gray-600">Configure instruções específicas para os modelos de IA</p>
                </div>
            </div>
            <a href="{{ url_for('admin_panel') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar
            </a>
        </div>
    </div>

    <!-- Instruções Gerais -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-cog mr-2 text-purple-600"></i>
            Instruções Gerais
        </h3>
        <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="save_general">
            
            <div>
                <label for="general_instructions" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-edit mr-1"></i>Instruções
                </label>
                <textarea id="general_instructions" name="general_instructions" rows="6"
                          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                          placeholder="Ex: Você é um juiz experiente especializado em direito civil. Suas decisões devem ser baseadas apenas nos fatos apresentados e na legislação aplicável...">{{ general_instructions }}</textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Estas instruções serão aplicadas a todos os modelos. Defina a persona, restrições e diretrizes gerais.
                </p>
            </div>
            
            <div class="flex justify-end">
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-save mr-2"></i>
                    Salvar Instruções Gerais
                </button>
            </div>
        </form>
    </div>

    <!-- Personalização por Modelo -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-user-cog mr-2 text-purple-600"></i>
            Personalizar por Modelo
        </h3>
        
        <div class="mb-4">
            <label for="model_selector" class="block text-sm font-medium text-gray-700 mb-2">Selecionar Modelo</label>
            <select id="model_selector" 
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                    onchange="loadModelInstructions()">
                <option value="">Escolha um modelo para personalizar...</option>
                {% for model in available_models %}
                <option value="{{ model.id }}">
                    {{ model.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <form method="POST" id="model_form" class="space-y-4" style="display: none;">
            <input type="hidden" name="action" value="save_model">
            <input type="hidden" name="model_id" id="model_id_input">
            
            <div>
                <label for="model_instructions" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-edit mr-1"></i>Instruções do Modelo
                </label>
                <textarea id="model_instructions" name="model_instructions" rows="8"
                          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                          placeholder="As instruções gerais aparecerão aqui. Você pode editá-las para personalizar este modelo específico..."></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Personalize as instruções para este modelo específico. As instruções gerais são carregadas como base.
                </p>
            </div>
            
            <div class="flex items-center">
                <input type="checkbox" id="is_active" name="is_active" checked
                       class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                <label for="is_active" class="ml-2 text-sm text-gray-700">Instruções ativas</label>
            </div>
            
            <div class="flex justify-between">
                <button type="button" onclick="resetToGeneral()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-undo mr-2"></i>
                    Restaurar Instruções Gerais
                </button>
                
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-save mr-2"></i>
                    Salvar Instruções do Modelo
                </button>
            </div>
        </form>
    </div>

    <!-- Lista de Modelos Personalizados -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-list mr-2 text-purple-600"></i>
            Modelos Personalizados
        </h3>
        
        {% if instructions_list %}
        <div class="space-y-4">
            {% for instruction in instructions_list %}
            <div class="border border-gray-200 rounded-lg p-4 {% if not instruction.is_active %}bg-gray-50{% endif %}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-3">
                            <h4 class="text-lg font-medium text-gray-900">{{ instruction.model_id }}</h4>
                            {% if instruction.is_active %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Ativo
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-pause mr-1"></i>Inativo
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ instruction.instructions }}</p>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-3">
                            Criado em: {{ instruction.created_at.strftime('%d/%m/%Y %H:%M') }}
                            {% if instruction.updated_at != instruction.created_at %}
                            | Atualizado em: {{ instruction.updated_at.strftime('%d/%m/%Y %H:%M') }}
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="ml-4 flex space-x-2">
                        <button onclick="editModelInstruction('{{ instruction.model_id }}', `{{ instruction.instructions|e }}`, {{ 'true' if instruction.is_active else 'false' }})" 
                                class="text-blue-600 hover:text-blue-900" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form method="POST" onsubmit="return confirm('Tem certeza que deseja excluir estas instruções?')" class="inline">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="model_id" value="{{ instruction.model_id }}">
                            <button type="submit" class="text-red-600 hover:text-red-900" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-robot text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">Nenhum modelo personalizado ainda.</p>
            <p class="text-sm text-gray-400">Selecione um modelo acima para criar instruções personalizadas.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
let generalInstructions = `{{ general_instructions|e }}`;

function loadModelInstructions() {
    const modelSelector = document.getElementById('model_selector');
    const selectedModel = modelSelector.value;
    const modelForm = document.getElementById('model_form');
    const modelIdInput = document.getElementById('model_id_input');
    const modelInstructions = document.getElementById('model_instructions');
    
    if (!selectedModel) {
        modelForm.style.display = 'none';
        return;
    }
    
    // Mostrar formulário
    modelForm.style.display = 'block';
    modelIdInput.value = selectedModel;
    
    // Carregar instruções existentes ou usar as gerais como base
    fetch(`{{ url_for("admin_instructions") }}?action=get_model&model_id=${selectedModel}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.instructions) {
                modelInstructions.value = data.instructions;
                document.getElementById('is_active').checked = data.is_active;
            } else {
                // Usar instruções gerais como base
                modelInstructions.value = generalInstructions;
                document.getElementById('is_active').checked = true;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar instruções:', error);
            modelInstructions.value = generalInstructions;
            document.getElementById('is_active').checked = true;
        });
}

function resetToGeneral() {
    document.getElementById('model_instructions').value = generalInstructions;
    showNotification('Instruções gerais restauradas!', 'info');
}

function editModelInstruction(modelId, instructions, isActive) {
    // Selecionar o modelo no dropdown
    document.getElementById('model_selector').value = modelId;
    
    // Carregar as instruções
    document.getElementById('model_id_input').value = modelId;
    document.getElementById('model_instructions').value = instructions;
    document.getElementById('is_active').checked = isActive === 'true';
    
    // Mostrar formulário
    document.getElementById('model_form').style.display = 'block';
    
    // Scroll para o formulário
    document.getElementById('model_form').scrollIntoView({ behavior: 'smooth' });
    
    showNotification('Modo de edição ativado. Clique em "Salvar Instruções do Modelo" para atualizar.', 'info');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            showNotification('{{ message }}', '{{ "success" if category == "success" else "error" if category == "error" else "info" }}');
        {% endfor %}
    {% endif %}
{% endwith %}
</script>
{% endblock %} 