{% extends "base.html" %}

{% block title %}Instruções dos Modelos - DIRIA{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-robot text-3xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <h1 class="text-2xl font-bold text-gray-900">Instruções dos Modelos</h1>
                    <p class="text-sm text-gray-600">Configure personas, vedações e instruções específicas por modelo de IA</p>
                </div>
            </div>
            <a href="{{ url_for('admin_panel') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar
            </a>
        </div>
    </div>

    <!-- Templates Pré-definidos -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-layer-group mr-2 text-purple-600"></i>
            Templates Pré-definidos
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 cursor-pointer" 
                 onclick="loadTemplate('juiz_experiente')">
                <h4 class="font-medium text-gray-900 mb-2">Juiz Experiente</h4>
                <p class="text-sm text-gray-600">Persona de juiz com mais de 20 anos de experiência em direito civil</p>
            </div>
            <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 cursor-pointer" 
                 onclick="loadTemplate('juiz_rigoroso')">
                <h4 class="font-medium text-gray-900 mb-2">Juiz Rigoroso</h4>
                <p class="text-sm text-gray-600">Persona de juiz que prioriza rigor técnico e formalidade</p>
            </div>
            <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 cursor-pointer" 
                 onclick="loadTemplate('juiz_equitativo')">
                <h4 class="font-medium text-gray-900 mb-2">Juiz Equitativo</h4>
                <p class="text-sm text-gray-600">Persona de juiz que busca equilíbrio entre direito e equidade</p>
            </div>
        </div>
    </div>

    <!-- Formulário de Adição/Edição -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-plus mr-2 text-purple-600"></i>
            Configurar Instruções do Modelo
        </h3>
        <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="create">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="model_id" class="block text-sm font-medium text-gray-700 mb-2">Modelo de IA</label>
                    <select id="model_id" name="model_id" required
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                        <option value="">Selecione um modelo...</option>
                        {% for model in available_models %}
                        <option value="{{ model.id }}">
                            {{ model.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">
                        Escolha o modelo para o qual deseja configurar instruções específicas.
                    </p>
                </div>
                
                <div>
                    <label for="copy_from_model" class="block text-sm font-medium text-gray-700 mb-2">Copiar de outro modelo</label>
                    <select id="copy_from_model" name="copy_from_model"
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                            onchange="copyInstructions()">
                        <option value="">Selecione para copiar...</option>
                        {% for instruction in instructions_list %}
                        <option value="{{ instruction.model_id }}">
                            {{ instruction.model_id }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">
                        Copie instruções de um modelo já configurado.
                    </p>
                </div>
            </div>
            
            <div>
                <label for="persona" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user-tie mr-1"></i>Persona
                </label>
                <textarea id="persona" name="persona" rows="3"
                          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                          placeholder="Ex: Você é um juiz experiente especializado em direito civil, com mais de 20 anos de experiência..."></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Defina a persona que o modelo deve assumir ao gerar respostas.
                </p>
            </div>
            
            <div>
                <label for="restrictions" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-ban mr-1"></i>Restrições/Vedações
                </label>
                <textarea id="restrictions" name="restrictions" rows="3"
                          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                          placeholder="Ex: Não mencione nomes de pessoas, não faça suposições sobre fatos não apresentados..."></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Especifique limitações e vedações que o modelo deve seguir.
                </p>
            </div>
            
            <div>
                <label for="introduction" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-play mr-1"></i>Introdução
                </label>
                <textarea id="introduction" name="introduction" rows="3"
                          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                          placeholder="Ex: Com base nos dados fornecidos e na legislação aplicável..."></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Texto introdutório que será adicionado no início de cada prompt.
                </p>
            </div>
            
            <div>
                <label for="conclusion" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-flag-checkered mr-1"></i>Conclusão
                </label>
                <textarea id="conclusion" name="conclusion" rows="3"
                          class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                          placeholder="Ex: Assinado eletronicamente, [Nome do Juiz], Data: [Data atual]"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Texto de conclusão que será adicionado no final de cada resposta.
                </p>
            </div>
            
            <div class="flex items-center">
                <input type="checkbox" id="is_active" name="is_active" checked
                       class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                <label for="is_active" class="ml-2 text-sm text-gray-700">Instruções ativas</label>
            </div>
            
            <div class="flex justify-between">
                <button type="button" onclick="applyToAllModels()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-copy mr-2"></i>
                    Aplicar a Todos os Modelos
                </button>
                
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-save mr-2"></i>
                    Salvar Instruções
                </button>
            </div>
        </form>
    </div>

    <!-- Lista de Instruções Configuradas -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-list mr-2 text-purple-600"></i>
            Instruções Configuradas
        </h3>
        
        {% if instructions_list %}
        <div class="space-y-4">
            {% for instruction in instructions_list %}
            <div class="border border-gray-200 rounded-lg p-4 {% if not instruction.is_active %}bg-gray-50{% endif %}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-3">
                            <h4 class="text-lg font-medium text-gray-900">{{ instruction.model_id }}</h4>
                            {% if instruction.is_active %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Ativo
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-pause mr-1"></i>Inativo
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% if instruction.persona %}
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-user-tie mr-1"></i>Persona
                                </h5>
                                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">{{ instruction.persona }}</p>
                            </div>
                            {% endif %}
                            
                            {% if instruction.restrictions %}
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-ban mr-1"></i>Restrições
                                </h5>
                                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">{{ instruction.restrictions }}</p>
                            </div>
                            {% endif %}
                            
                            {% if instruction.introduction %}
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-play mr-1"></i>Introdução
                                </h5>
                                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">{{ instruction.introduction }}</p>
                            </div>
                            {% endif %}
                            
                            {% if instruction.conclusion %}
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-1">
                                    <i class="fas fa-flag-checkered mr-1"></i>Conclusão
                                </h5>
                                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">{{ instruction.conclusion }}</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-3">
                            Criado em: {{ instruction.created_at.strftime('%d/%m/%Y %H:%M') }}
                            {% if instruction.updated_at != instruction.created_at %}
                            | Atualizado em: {{ instruction.updated_at.strftime('%d/%m/%Y %H:%M') }}
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="ml-4 flex space-x-2">
                        <button onclick="editInstruction(this)" 
                                data-model-id="{{ instruction.model_id }}"
                                data-persona="{{ instruction.persona|e }}"
                                data-restrictions="{{ instruction.restrictions|e }}"
                                data-introduction="{{ instruction.introduction|e }}"
                                data-conclusion="{{ instruction.conclusion|e }}"
                                data-is-active="{{ 'true' if instruction.is_active else 'false' }}"
                                class="text-blue-600 hover:text-blue-900" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form method="POST" onsubmit="return confirm('Tem certeza que deseja excluir estas instruções?')" class="inline">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="model_id" value="{{ instruction.model_id }}">
                            <button type="submit" class="text-red-600 hover:text-red-900" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-robot text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">Nenhuma instrução configurada ainda.</p>
            <p class="text-sm text-gray-400">Configure instruções para seus modelos de IA acima.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para Aplicar a Todos os Modelos -->
<div id="applyToAllModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    Aplicar a Todos os Modelos
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Esta ação irá criar ou atualizar instruções para todos os modelos disponíveis com as configurações atuais do formulário.
                </p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeApplyToAllModal()" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Cancelar
                    </button>
                    <button onclick="confirmApplyToAll()" 
                            class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Templates pré-definidos
const templates = {
    'juiz_experiente': {
        persona: 'Você é um juiz experiente especializado em direito civil, com mais de 20 anos de experiência no Poder Judiciário. Possui vasto conhecimento em procedimentos judiciais, interpretação de leis e aplicação do direito. Sua abordagem é equilibrada, considerando tanto aspectos técnicos quanto humanísticos.',
        restrictions: 'Não mencione nomes de pessoas físicas ou jurídicas específicas. Não faça suposições sobre fatos não apresentados. Base suas decisões apenas nos dados fornecidos e na legislação aplicável. Mantenha linguagem formal e técnica apropriada para documentos judiciais.',
        introduction: 'Com base nos dados fornecidos e na legislação aplicável, considerando os princípios do devido processo legal e da ampla defesa,',
        conclusion: 'Assinado eletronicamente, [Nome do Juiz], Juiz de Direito, Data: [Data atual]'
    },
    'juiz_rigoroso': {
        persona: 'Você é um juiz rigoroso que prioriza o rigor técnico, a formalidade processual e a estrita observância da lei. Sua abordagem é meticulosa e baseada em precedentes jurisprudenciais estabelecidos.',
        restrictions: 'Não mencione nomes de pessoas. Não faça interpretações extensivas da lei. Mantenha-se estritamente aos fatos apresentados e à letra da lei. Use linguagem técnica e formal.',
        introduction: 'Considerando estritamente os fatos apresentados e a legislação em vigor,',
        conclusion: 'Assinado eletronicamente, [Nome do Juiz], Juiz de Direito, Data: [Data atual]'
    },
    'juiz_equitativo': {
        persona: 'Você é um juiz que busca o equilíbrio entre a aplicação rigorosa do direito e a equidade. Considera aspectos humanísticos e sociais em suas decisões, sempre dentro dos limites legais.',
        restrictions: 'Não mencione nomes de pessoas. Não faça suposições sobre fatos não apresentados. Considere aspectos de equidade sem desrespeitar a lei. Mantenha linguagem acessível mas técnica.',
        introduction: 'Considerando os fatos apresentados, a legislação aplicável e os princípios de equidade,',
        conclusion: 'Assinado eletronicamente, [Nome do Juiz], Juiz de Direito, Data: [Data atual]'
    }
};

function loadTemplate(templateName) {
    const template = templates[templateName];
    if (template) {
        document.getElementById('persona').value = template.persona;
        document.getElementById('restrictions').value = template.restrictions;
        document.getElementById('introduction').value = template.introduction;
        document.getElementById('conclusion').value = template.conclusion;
        
        // Mostrar notificação
        showNotification('Template carregado com sucesso!', 'success');
    }
}

function copyInstructions() {
    const copyFromSelect = document.getElementById('copy_from_model');
    const selectedModel = copyFromSelect.value;
    
    if (!selectedModel) return;
    
    // Encontrar as instruções do modelo selecionado
    const instructionElement = document.querySelector(`[data-model-id="${selectedModel}"]`);
    if (instructionElement) {
        const persona = instructionElement.getAttribute('data-persona');
        const restrictions = instructionElement.getAttribute('data-restrictions');
        const introduction = instructionElement.getAttribute('data-introduction');
        const conclusion = instructionElement.getAttribute('data-conclusion');
        
        document.getElementById('persona').value = persona || '';
        document.getElementById('restrictions').value = restrictions || '';
        document.getElementById('introduction').value = introduction || '';
        document.getElementById('conclusion').value = conclusion || '';
        
        showNotification('Instruções copiadas com sucesso!', 'success');
    }
    
    // Resetar o select
    copyFromSelect.value = '';
}

function applyToAllModels() {
    // Verificar se há dados no formulário
    const persona = document.getElementById('persona').value;
    const restrictions = document.getElementById('restrictions').value;
    const introduction = document.getElementById('introduction').value;
    const conclusion = document.getElementById('conclusion').value;
    
    if (!persona && !restrictions && !introduction && !conclusion) {
        showNotification('Preencha pelo menos um campo antes de aplicar a todos os modelos.', 'error');
        return;
    }
    
    document.getElementById('applyToAllModal').classList.remove('hidden');
}

function closeApplyToAllModal() {
    document.getElementById('applyToAllModal').classList.add('hidden');
}

function confirmApplyToAll() {
    const formData = new FormData();
    formData.append('action', 'apply_to_all');
    formData.append('persona', document.getElementById('persona').value);
    formData.append('restrictions', document.getElementById('restrictions').value);
    formData.append('introduction', document.getElementById('introduction').value);
    formData.append('conclusion', document.getElementById('conclusion').value);
    formData.append('is_active', document.getElementById('is_active').checked);
    
    fetch('{{ url_for("admin_instructions") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Instruções aplicadas a todos os modelos com sucesso!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Erro ao aplicar instruções.', 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao aplicar instruções.', 'error');
    });
    
    closeApplyToAllModal();
}

function editInstruction(button) {
    const modelId = button.getAttribute('data-model-id');
    const persona = button.getAttribute('data-persona');
    const restrictions = button.getAttribute('data-restrictions');
    const introduction = button.getAttribute('data-introduction');
    const conclusion = button.getAttribute('data-conclusion');
    const isActive = button.getAttribute('data-is-active') === 'true';
    
    // Preencher formulário
    document.getElementById('model_id').value = modelId;
    document.getElementById('persona').value = persona;
    document.getElementById('restrictions').value = restrictions;
    document.getElementById('introduction').value = introduction;
    document.getElementById('conclusion').value = conclusion;
    document.getElementById('is_active').checked = isActive;
    
    // Mudar ação do formulário para update
    document.querySelector('input[name="action"]').value = 'update';
    
    // Scroll para o formulário
    document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
    
    showNotification('Modo de edição ativado. Clique em "Salvar Instruções" para atualizar.', 'info');
}

function showNotification(message, type) {
    // Criar notificação
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remover após 3 segundos
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %} 